<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ECR‑R (Türkçe) v2 – İnteraktif Form</title>
    <style>
        :root {
            --bg: #0b1020; --card: #121831; --muted: #99a2c2; --ink: #e8ecff;
            --accent: #6aa0ff; --accent2: #7fffd4; --danger: #ff6a8a;
            --border-color: #1e2744; --border-color-light: #283050;
        }
        html, body { height: 100% }
        body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background: linear-gradient(180deg, #0b1020, #0a0e1a 60%); color: var(--ink) }
        .wrap { max-width: 980px; margin-inline: auto; padding: 24px }
        header { position: sticky; top: 0; z-index: 5; background: rgba(11, 16, 32, .8); backdrop-filter: saturate(140%) blur(8px); border-bottom: 1px solid var(--border-color-light) }
        header .wrap { display: flex; gap: 16px; align-items: center; justify-content: space-between; padding-block: 10px }
        h1 { font-size: clamp(18px, 3.2vw, 28px); margin: 0; letter-spacing: .2px }
        .muted { color: var(--muted) }
        .card { background: var(--card); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: 0 6px 24px rgba(0, 0, 0, .25) }
        .panel { padding: 18px }
        .controls { display: flex; flex-wrap: wrap; gap: 8px }
        button { background: #1a2242; border: 1px solid #2a3560; color: var(--ink); padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
        button:hover { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(106, 160, 255, .12) }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        button.primary { background: linear-gradient(180deg, #2a5cff, #1a3ed6); border-color: #2a5cff }
        button.ghost { background: transparent }
        button.danger { background: #3a1430; border-color: #7a1e55 }
        .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; font-weight: 700; border: 1px solid #2b3764; border-radius: 999px }
        .badge .dot { width: 8px; height: 8px; border-radius: 50% }
        .badge.a .dot { background: var(--accent2) }
        .badge.b .dot { background: var(--accent) }
        .badge.c .dot { background: #ffcf6a }
        .kpis { display: flex; flex-wrap: wrap; gap: 10px }
        .kpis .card { display: flex; gap: 10px; align-items: center; padding: 10px 14px }
        .progress { height: 10px; background: #1b2344; border: 1px solid #2a3560; border-radius: 999px; overflow: hidden }
        .progress>span { display: block; height: 100%; background: linear-gradient(90deg, var(--accent), #55e0ff); width: 0; transition: width 0.3s ease; }
        .foot { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-top: 12px; padding: 12px; }
        .small { font-size: 12px }
        .tip { border-left: 3px solid var(--accent); padding: 12px; margin: 14px 0; background: #0f1630 }
        
        /* Table Styles */
        .question-table { width: 100%; border-collapse: collapse; margin-top: 14px; }
        .question-table th, .question-table td { padding: 14px; text-align: left; border-top: 1px solid #1d2543; }
        .question-table thead { color: var(--muted); }
        .question-table th { font-weight: 700; }
        .question-table th:not(:first-child), .question-table td:not(:first-child) { text-align: center; }
        .question-table tr:hover { background-color: rgba(255,255,255,0.03); }

        /* Checkbox Styles */
        input[type="checkbox"] {
            -webkit-appearance: none; appearance: none; background-color: transparent; 
            margin-inline: auto;
            font: inherit; color: currentColor; width: 1.25em; height: 1.25em;
            border: 0.15em solid #4a5568; border-radius: 0.25rem;
            display: grid; place-content: center; cursor: pointer;
        }
        input[type="checkbox"]::before {
            content: ""; width: 0.65em; height: 0.65em; transform: scale(0);
            transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em var(--accent);
            transform-origin: bottom left; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        input[type="checkbox"]:checked { border-color: var(--accent); background-color: var(--accent); }
        input[type="checkbox"]:checked::before { transform: scale(1); }
        
        /* AI Section Styles */
        #ai-result-container {
            background: #0f1630;
            border: 1px solid var(--border-color-light);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
        }
        #ai-result-container h2 {
            margin: 0 0 16px 0;
            color: var(--accent2);
            font-size: 20px;
        }
        #ai-result {
            line-height: 1.7;
            color: var(--muted);
        }
        .loader {
            width: 50px;
            aspect-ratio: 1;
            border-radius: 50%;
            border: 8px solid #55e0ff;
            border-right-color: var(--accent);
            animation: l2 1s infinite linear;
            margin: 20px auto;
        }
        @keyframes l2 {to{transform: rotate(1turn)}}


        @media (max-width: 700px) {
            header .wrap { flex-direction: column; align-items: flex-start }
        }
        @media print {
            header, .controls, .tip, .foot, #ai-section { display: none !important }
            body { background: #fff; color: #000 }
            .card { background: #fff; border-color: #bbb; box-shadow: none; }
            .question-table { page-break-inside: auto; }
            .question-table tr { page-break-inside: avoid; page-break-after: auto; }
            .kpis .card { border-color: #bbb; }
        }
    </style>
</head>
<body>
    <header>
        <div class="wrap">
            <h1>ECR‑R (Türkçe) – İnteraktif Form</h1>
            <div class="controls">
                <button class="primary" id="btnExportJson">JSON indir</button>
                <button id="btnExportCsv">CSV indir</button>
                <button id="btnCopy">Özeti kopyala</button>
                <button class="ghost" id="btnPrint">Yazdır / PDF</button>
                <button class="danger" id="btnReset">Temizle</button>
            </div>
        </div>
    </header>

    <main class="wrap">
        <section class="card panel">
            <p class="muted">Bu form, Fraley, Waller & Brennan (2000) ECR‑R ölçeğinin Türkçe uyarlamasındaki ifadelerin satır başına A/B/C seçenekleriyle işaretlenmesi için düzenlenmiştir. Aşağıdaki sayaçlar canlı olarak güncellenir ve yanıtlarınız tarayıcınızda <em>yerel olarak</em> saklanır.</p>
            <div class="kpis">
                <div class="card badge a"><span class="dot"></span> A sayısı: <span id="countA">0</span></div>
                <div class="card badge b"><span class="dot"></span> B sayısı: <span id="countB">0</span></div>
                <div class="card badge c"><span class="dot"></span> C sayısı: <span id="countC">0</span></div>
                <div class="card"><strong>Cevaplanan:</strong>&nbsp;<span id="answered">0</span>/<span id="total">0</span></div>
            </div>
            <div class="progress" aria-hidden="true" style="margin-top:10px"><span id="bar"></span></div>
            <div class="tip small">Not: Orijinal materyalde yer alan “<em>A sütunundan işaretlediğiniz kutuların toplamı</em>” ibaresi için yukarıdaki <strong>A sayısı</strong> değerini kullanabilirsiniz.</div>

            <form id="form" class="card">
                <table class="question-table">
                    <thead>
                        <tr>
                            <th style="width: 70%;">İfade</th>
                            <th style="width: 10%;">A</th>
                            <th style="width: 10%;">B</th>
                            <th style="width: 10%;">C</th>
                        </tr>
                    </thead>
                    <tbody id="questions-tbody"></tbody>
                </table>
                <div class="foot">
                    <div class="small muted">Yanıtlar tarayıcınızda otomatik kaydedilir.</div>
                    <button id="btnScrollTop" type="button">Başa dön</button>
                </div>
            </form>
        </section>

        <section id="ai-section" class="panel">
            <button id="btnGetAI" class="primary w-full" style="width: 100%; padding-block: 14px; font-size: 16px;">Karakter Analizi İste (Yapay Zeka)</button>
            <div id="ai-result-container" style="display: none;">
                <h2>Psikolojik Değerlendirme</h2>
                <div id="ai-result"></div>
            </div>
        </section>

        <section class="panel muted small">
            <p><strong>Uyarı:</strong> Bu araç bilgilendirme ve kişisel farkındalık amaçlıdır; bir değerlendirme/teşhis aracı değildir. Yapay zeka tarafından üretilen yorumlar tavsiye niteliği taşımaz.</p>
        </section>
    </main>

    <script>
    const DATA = [
        { text: "Partnerlerime rahatlıkla güvenirim.", col: "B" },
        { text: "Bağımsızlığım ilişkilerimden önemlidir.", col: "C" },
        { text: "En derin hislerimi partnerimle paylaşmayı tercih etmem.", col: "C" },
        { text: "Partnerime nasıl hissettiğimi gösterirsem benim için aynı şekilde hissetmeyeceğinden korkarım.", col: "A" },
        { text: "Romantik ilişkilerimden genellikle memnunum.", col: "B" },
        { text: "Romantik ilişkilerimde trip atma ihtiyacı hissetmem.", col: "B" },
        { text: "İlişkilerim hakkında çok düşünürüm.", col: "A" },
        { text: "Partnerlerime güvenmekte zorluk çekerim.", col: "C" },
        { text: "Bir partnere hızla bağlanma eğilimim vardır.", col: "A" },
        { text: "İhtiyaçlarımı ve isteklerimi partnerime ifade etmekte pek zorlanmam.", col: "B" },
        { text: "Partnerime zaman zaman nedenini bilmeden öfke duyar ve sinir olurum.", col: "C" },
        { text: "Partnerimin ruh hali beni çok etkiler.", col: "A" },
        { text: "İnsanların çoğunlukla dürüst ve güvenilir olduğuna inanırım.", col: "B" },
        { text: "Tek bir partnerle yakınlık kurmak yerine, kimseye bağlanmadığım tek gecelik ilişkileri tercih ederim.", col: "C" },
        { text: "Kişisel fikirlerimi ve duygularımı partnerimle rahatça paylaşırım.", col: "B" },
        { text: "Partnerim beni terk ederse, bir daha kimseyi bulamayacağımdan endişe duyarım.", col: "A" },
        { text: "Partnerim çok yakınlaştığında gerilirim.", col: "C" },
        { text: "Sıklıkla partnerimin beni sevmekten vazgeçeceğinden endişe duyarım.", col: "A" },
        { text: "Partnerime şefkat göstermekte zorlanmam.", col: "B" },
        { text: "Biri gerçek beni tanıdığında, olduğum kişiden hoşlanmayacağından korkarım.", col: "A" },
        { text: "Bir ayrılığın ardından çabucak toparlanırım. Birini bu kadar çabuk aklımdan çıkarmam tuhaf.", col: "C" },
        { text: "Bir ilişkide olmadığımda kendimi kaygılı ve eksik hissederim.", col: "A" },
        { text: "Partnerim kendini kötü hissettiğinde ona duygusal destek vermekte zorlanırım.", col: "C" },
        { text: "Partnerim uzakta olduğunda, bir başkasıyla ilgileneceğinden korkarım.", col: "A" },
        { text: "Bir çatışma ânında, meselenin gerekçelerini konuşmak yerine, düşünmeden sonradan pişman olacağım şeyler yapma ve söyleme eğilimim vardır.", col: "A" },
        { text: "Partnerimle tartışmak ilişkimizin tamamını sorgulamama sebep olmaz.", col: "B" },
        { text: "Partnerlerim, genellikle benim rahat hissettiğimden daha fazla yakınlık kurmak ister.", col: "C" },
        { text: "Yeterince çekici olmadığımdan endişe duyarım.", col: "A" },
        { text: "İlişkilerimde pek dram yaratmadığım için insanların beni sıkıcı bulduğu olur.", col: "B" },
        { text: "Partnerimi ayrıyken özler, bir aradayken kaçma isteği duyarım.", col: "C" },
        { text: "Biriyle fikir ayrılığı yaşadığımda düşüncelerimi rahatça ifade edebilirim.", col: "B" },
        { text: "Başka insanların bana bağımlı olduğu hissinden nefret ederim.", col: "C" },
        { text: "İlgilendiğim birinin başkalarıyla ilgilenmesi beni korkutamaz. Belli belirsiz bir kıskançlık hissederim ama uçup gider.", col: "B" },
        { text: "İlgilendiğim birinin başkalarıyla ilgilendiğini görünce rahatlamış hissederim. Daha özel bir şeylerin peşinde olmadığını gösterir.", col: "C" },
        { text: "İlgilendiğim birinin başkalarıyla ilgilendiğini görmek bana kendimi depresif hissettirir.", col: "A" },
        { text: "Çıktığım kişi soğuk ve uzak davranırsa, ne olup bittiğini merak ederim ama muhtemelen benimle ilgili olmadığını bilirim.", col: "B" },
        { text: "Çıktığım kişi soğuk ve uzak davranırsa, muhtemelen aldırmam, hatta biraz rahatlamış hissederim.", col: "C" },
        { text: "Çıktığım kişi soğuk ve uzak davranırsa, bir şeyleri yanlış yaptığımdan endişe duyarım.", col: "A" },
        { text: "Partnerim benden ayrılacak olursa, ona ne kaçırdığını göstermek için elimden geleni yaparım (biraz kıskançlıktan zarar gelmez).", col: "A" },
        { text: "Birkaç aydır çıktığım biri benden ayrılmak isterse, başta incinirim ama daha sonra toparlarım.", col: "B" },
        { text: "Bazen ilişkide istediğimi elde ettikten sonra, artık neyi istediğimden emin olmam.", col: "C" },
        { text: "Eski partnerlerimle (tamamen platonik olarak) bağlantıda kalmaktan rahatsızlık duymam. Nihayetinde birçok ortak yönümüz var.", col: "B" }
    ];

    const ROOT_KEY = 'ecrr_form_v2_checkbox';
    const elements = {
        tbody: document.getElementById('questions-tbody'),
        countA: document.getElementById('countA'),
        countB: document.getElementById('countB'),
        countC: document.getElementById('countC'),
        answered: document.getElementById('answered'),
        total: document.getElementById('total'),
        bar: document.getElementById('bar'),
        aiResultContainer: document.getElementById('ai-result-container'),
        aiResult: document.getElementById('ai-result'),
        btnGetAI: document.getElementById('btnGetAI'),
    };

    function buildUI() {
        elements.total.textContent = DATA.length;
        DATA.forEach((q, i) => {
            const row = elements.tbody.insertRow();
            const textCell = row.insertCell();
            textCell.textContent = `${i + 1}. ${q.text}`;

            ['A', 'B', 'C'].forEach(letter => {
                const cell = row.insertCell();
                if (q.col === letter) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `q${i}`;
                    checkbox.dataset.col = q.col;
                    checkbox.addEventListener('change', saveAndUpdate);
                    cell.appendChild(checkbox);
                }
            });
        });
    }

    function getState() {
        const state = {};
        document.querySelectorAll('#questions-tbody input[type="checkbox"]').forEach((box, i) => {
            if (box.checked) {
                state[`q${i}`] = true;
            }
        });
        return state;
    }

    function saveAndUpdate() {
        const state = getState();
        localStorage.setItem(ROOT_KEY, JSON.stringify(state));
        updateCounters();
    }
    
    function loadState() {
        const saved = JSON.parse(localStorage.getItem(ROOT_KEY) || '{}');
        Object.entries(saved).forEach(([key, value]) => {
            const index = key.replace('q', '');
            const checkbox = document.getElementById(`q${index}`);
            if (checkbox && value) {
                checkbox.checked = true;
            }
        });
    }

    function updateCounters() {
        let a = 0, b = 0, c = 0;
        const checkedBoxes = document.querySelectorAll('#questions-tbody input:checked');
        checkedBoxes.forEach(box => {
            if (box.dataset.col === 'A') a++;
            else if (box.dataset.col === 'B') b++;
            else if (box.dataset.col === 'C') c++;
        });
        
        elements.countA.textContent = a;
        elements.countB.textContent = b;
        elements.countC.textContent = c;
        elements.answered.textContent = checkedBoxes.length;
        elements.bar.style.width = `${(checkedBoxes.length / DATA.length) * 100}%`;
    }

    async function getAiInterpretation() {
        const checkedBoxes = document.querySelectorAll('#questions-tbody input:checked');
        if (checkedBoxes.length === 0) {
            alert("Analiz için lütfen önce bazı ifadeleri işaretleyin.");
            return;
        }

        elements.btnGetAI.disabled = true;
        elements.aiResultContainer.style.display = 'block';
        elements.aiResult.innerHTML = '<div class="loader"></div>';
        elements.aiResultContainer.scrollIntoView({ behavior: 'smooth' });

        const selectedSentences = [];
        DATA.forEach((q, i) => {
            const box = document.getElementById(`q${i}`);
            if (box.checked) {
                selectedSentences.push(q.text);
            }
        });

        const prompt = `
            Sen, danışanının doldurduğu bir anketin sonuçlarını yorumlayan deneyimli bir psikologsun.
            Görevin, danışanının işaretlediği aşağıdaki ifadelere dayanarak onun ilişkilerdeki dinamikleri, temel korkuları, beklentileri ve bağlanma stili hakkında derinlemesine bir karakter analizi yapmaktır. Yorumun empatik, içgörülü ve yapıcı olmalı. Bir teşhis koymaktan kaçın, bunun yerine danışanın kendini daha iyi anlamasına yardımcı olacak çıkarımlarda bulun. Cevabı direkt olarak analize başlayarak ver.

            Danışanın katıldığını belirttiği ifadeler şunlar:
            - ${selectedSentences.join('\n- ') || 'Hiçbir ifade seçilmedi.'}

            Lütfen bu ifadelere dayanarak karakter analizini yap. Fakat analizin 6 cümleyi geçmesin.
        `;
        
        try {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=AIzaSyDvhdZjcOiut2LPOM7gzLZzxC_M47H1AbY`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API isteği başarısız oldu: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                elements.aiResult.innerText = text;
            } else {
                throw new Error("API'den geçerli bir yanıt alınamadı.");
            }

        } catch (error) {
            console.error("Yapay zeka yorumu alınırken hata:", error);
            elements.aiResult.innerText = "Analiz alınırken bir hata oluştu. Lütfen daha sonra tekrar deneyin.";
        } finally {
            elements.btnGetAI.disabled = false;
        }
    }


    // --- Button Event Listeners ---
    document.getElementById('btnReset').addEventListener('click', () => {
        if (!window.confirm('Tüm işaretlemeleri temizlemek istediğinize emin misiniz?')) return;
        localStorage.removeItem(ROOT_KEY);
        document.querySelectorAll('input[type=checkbox]').forEach(i => i.checked = false);
        updateCounters();
        elements.aiResultContainer.style.display = 'none';
        elements.aiResult.innerHTML = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    document.getElementById('btnPrint').addEventListener('click', () => window.print());
    document.getElementById('btnScrollTop').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    document.getElementById('btnGetAI').addEventListener('click', getAiInterpretation);

    document.getElementById('btnCopy').addEventListener('click', () => {
        const lines = [
            `ECR-R Anket Özeti`,
            `Toplam A: ${elements.countA.textContent}`,
            `Toplam B: ${elements.countB.textContent}`,
            `Toplam C: ${elements.countC.textContent}`,
            `Cevaplanan: ${elements.answered.textContent}/${DATA.length}`,
            '---',
        ];
        DATA.forEach((q, i) => {
            const box = document.getElementById(`q${i}`);
            const val = box.checked ? `[${q.col}]` : `[ ]`;
            lines.push(`${i + 1}. ${val} ${q.text}`);
        });
        const text = lines.join('\n');
        navigator.clipboard.writeText(text).then(() => {
            alert('Özet panoya kopyalandı.');
        }, () => {
            alert('Kopyalama başarısız oldu.');
        });
    });
    
    function triggerDownload(blob, filename) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(a.href), 5000);
    }

    function exportFile(kind) {
        const answers = [];
        DATA.forEach((q, i) => {
             const box = document.getElementById(`q${i}`);
             if(box.checked) {
                answers.push({ no: i + 1, secim: q.col, soru: q.text });
             }
        });

        if (kind === 'json') {
            const json = {
                sayimlar: { A: +elements.countA.textContent, B: +elements.countB.textContent, C: +elements.countC.textContent },
                cevaplar: answers
            };
            const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
            triggerDownload(blob, 'ecrr_tr_form.json');
        } else { // CSV
            let csv = '"no","secim","soru"\n';
            answers.forEach(row => {
                csv += `"${row.no}","${row.secim}","${String(row.soru).replace(/"/g, '""')}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            triggerDownload(blob, 'ecrr_tr_form.csv');
        }
    }

    document.getElementById('btnExportJson').addEventListener('click', () => exportFile('json'));
    document.getElementById('btnExportCsv').addEventListener('click', () => exportFile('csv'));
    
    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        buildUI();
        loadState();
        updateCounters();
    });
    </script>
</body>
</html>
